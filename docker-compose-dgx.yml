version: '3.9'

# ActiveCircuitDiscovery — DGX Spark Deployment
# Usage:
#   docker compose -f docker-compose-dgx.yml up -d           # start JupyterLab
#   docker compose -f docker-compose-dgx.yml --profile experiment up   # run full experiment

x-gpu-config: &gpu-config
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: all
            capabilities: [gpu]
  shm_size: '32gb'

x-common-env: &common-env
  CUDA_VISIBLE_DEVICES: all
  NCCL_DEBUG: WARN
  PYTORCH_CUDA_ALLOC_CONF: max_split_size_mb:512
  TOKENIZERS_PARALLELISM: false
  HF_HOME: /workspace/cache/models
  TRANSFORMERS_CACHE: /workspace/cache/models
  SAE_LENS_CACHE: /workspace/cache/saes
  WANDB_API_KEY: ${WANDB_API_KEY:-}
  WANDB_PROJECT: active-circuit-discovery

x-volumes: &common-volumes
  - ./results:/workspace/ActiveCircuitDiscovery/results
  - ./logs:/workspace/ActiveCircuitDiscovery/logs
  - ./visualizations:/workspace/ActiveCircuitDiscovery/visualizations
  - model-cache:/workspace/cache/models
  - sae-cache:/workspace/cache/saes

services:

  # ── Interactive JupyterLab ─────────────────────────────────────────────────
  jupyterlab:
    build:
      context: .
      dockerfile: Dockerfile
      cache_from:
        - activecircuitdiscovery:latest
    image: activecircuitdiscovery:latest
    container_name: acd_jupyterlab
    <<: *gpu-config
    environment:
      <<: *common-env
    volumes: *common-volumes
    ports:
      - "8888:8888"   # JupyterLab
      - "8050:8050"   # Dash dashboard
      - "6006:6006"   # TensorBoard
    restart: unless-stopped
    command: >
      jupyter lab
        --ip=0.0.0.0
        --port=8888
        --no-browser
        --allow-root
        --NotebookApp.token=''
        --NotebookApp.password=''
        --notebook-dir=/workspace/ActiveCircuitDiscovery

  # ── Experiment Runner (start with --profile experiment) ───────────────────
  experiment:
    image: activecircuitdiscovery:latest
    container_name: acd_experiment
    <<: *gpu-config
    depends_on:
      - jupyterlab
    environment:
      <<: *common-env
      EXPERIMENT_CONFIG: ${EXPERIMENT_CONFIG:-src/config/dgx_spark_config.yaml}
      EXPERIMENT_NAME: ${EXPERIMENT_NAME:-dgx_experiment}
    volumes: *common-volumes
    profiles:
      - experiment
    command: >
      python run_complete_experiment.py
        --config ${EXPERIMENT_CONFIG:-src/config/dgx_spark_config.yaml}
        --output-dir results/${EXPERIMENT_NAME:-dgx_experiment}
        --verbose

  # ── Visualisation Dashboard ───────────────────────────────────────────────
  dashboard:
    image: activecircuitdiscovery:latest
    container_name: acd_dashboard
    <<: *gpu-config
    environment:
      <<: *common-env
    volumes: *common-volumes
    ports:
      - "8050:8050"
    profiles:
      - dashboard
    command: >
      python -m src.visualization.research_dashboard
        --results-dir results
        --port 8050

volumes:
  model-cache:
    driver: local
  sae-cache:
    driver: local
