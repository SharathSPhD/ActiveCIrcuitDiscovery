% figures/circuit_flow.tex -- Flow of a single intervention step (TikZ)
% Updated for circuit-tracer feature_intervention API

\begin{tikzpicture}[
    font=\small,
    node distance = 0.7cm,
    flowstep/.style = {
        rectangle, draw=black!60, fill=white,
        rounded corners=2pt, minimum width=2.5cm, minimum height=0.55cm,
        align=center, line width=0.4pt
    },
    decision/.style = {
        diamond, draw=blue!60!black, fill=blue!6,
        aspect=2.5, minimum width=1cm, align=center,
        inner sep=1pt, font=\small, line width=0.4pt
    },
    arr/.style = {-{Latex[length=2mm]}, thick, draw=black!50},
    ann/.style = {font=\scriptsize, text=black!60},
]

% Steps
\node[flowstep] (s1) {Graph attribution\\(EAP + prune)};
\node[flowstep, below=of s1] (s2) {Extract candidates\\$(l, p, f)$};
\node[flowstep, below=of s2] (s3) {Score candidates\\$S(i) = \text{imp}\cdot\lambda_\ell + w\cdot u(i)$};
\node[flowstep, below=of s3] (s4) {Select $i^* = \arg\max S$};
\node[flowstep, below=of s4] (s5) {\texttt{model.feature\_intervention}\\$(l, p, f, \text{mult}=0)$};
\node[decision, below=0.8cm of s5] (d1) {$\Delta\text{KL}$?};
\node[flowstep, below right=0.8cm and 0.4cm of d1] (s6a) {$u(i^*)\gets 0$\\$\lambda_\ell +\!\!= |\Delta\text{KL}|$};
\node[flowstep, below left=0.8cm and 0.4cm of d1] (s6b) {$u(i^*)\gets 0$\\(no update to $\lambda_\ell$)};

% Arrows
\draw[arr] (s1) -- (s2);
\draw[arr] (s2) -- (s3);
\draw[arr] (s3) -- (s4);
\draw[arr] (s4) -- (s5);
\draw[arr] (s5) -- (d1);
\draw[arr] (d1) -- (s6a) node[midway, right, ann]{$>0$};
\draw[arr] (d1) -- (s6b) node[midway, left, ann]{$=0$};

% Loop arrow
\draw[arr, dashed] (s6a.north) -- ++(0, 0.2) -| ([xshift=1.5cm]s3.east) -- (s3.east)
    node[pos=0.15, right, ann]{next step};
\draw[arr, dashed] (s6b.north) -- ++(0, 0.2) -| ([xshift=-1.5cm]s3.west) -- (s3.west);

% Budget label
\node[ann, right=1.2cm of s4] {repeat $\le B$ times};

\end{tikzpicture}
