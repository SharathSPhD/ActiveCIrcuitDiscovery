% figures/circuit_flow.tex -- Flow of a single intervention step (TikZ)
% Compact version for IEEE single-column

\begin{tikzpicture}[
    font=\scriptsize,
    node distance = 0.5cm,
    flowstep/.style = {
        rectangle, draw=black!60, fill=white,
        rounded corners=2pt, minimum width=2.2cm, minimum height=0.45cm,
        align=center, line width=0.4pt
    },
    decision/.style = {
        diamond, draw=blue!60!black, fill=blue!6,
        aspect=2.5, minimum width=0.8cm, align=center,
        inner sep=1pt, font=\scriptsize, line width=0.4pt
    },
    arr/.style = {-{Latex[length=1.5mm]}, semithick, draw=black!50},
    ann/.style = {font=\tiny, text=black!60},
]

\node[flowstep] (s1) {EAP + prune};
\node[flowstep, below=of s1] (s2) {Extract candidates $(l, p, f)$};
\node[flowstep, below=of s2] (s3) {Score: $S = \text{imp}\cdot\lambda_\ell + \omega_e\cdot u$};
\node[flowstep, below=of s3] (s4) {Select $i^* = \arg\max S$};
\node[flowstep, below=of s4] (s5) {\texttt{feature\_intervention}$(l,p,f,0)$};
\node[decision, below=0.6cm of s5] (d1) {$\Delta$KL?};
\node[flowstep, below right=0.6cm and 0.2cm of d1] (s6a) {$u(i^*)\!\gets\!0$, update $\lambda_\ell$};
\node[flowstep, below left=0.6cm and 0.2cm of d1] (s6b) {$u(i^*)\!\gets\!0$, no update};

\draw[arr] (s1) -- (s2);
\draw[arr] (s2) -- (s3);
\draw[arr] (s3) -- (s4);
\draw[arr] (s4) -- (s5);
\draw[arr] (s5) -- (d1);
\draw[arr] (d1) -- (s6a) node[midway, right, ann]{$>0$};
\draw[arr] (d1) -- (s6b) node[midway, left, ann]{$=0$};

\draw[arr, dashed] (s6a.north) -- ++(0, 0.15) -| ([xshift=1.0cm]s3.east) -- (s3.east)
    node[pos=0.15, right, ann]{next};
\draw[arr, dashed] (s6b.north) -- ++(0, 0.15) -| ([xshift=-1.0cm]s3.west) -- (s3.west);

\node[ann, right=0.8cm of s4] {$\le B$ steps};

\end{tikzpicture}
