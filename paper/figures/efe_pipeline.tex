% figures/efe_pipeline.tex -- Scoring function pipeline (TikZ)
% Shows the pragmatic + epistemic scoring of the ActiveInferenceSelector

\begin{tikzpicture}[
    font=\small,
    node distance = 0.6cm and 1.2cm,
    box/.style = {
        rectangle, draw=black!60, fill=blue!6,
        rounded corners=2pt, minimum width=2.2cm, minimum height=0.6cm,
        align=center, line width=0.4pt
    },
    formula/.style = {
        rectangle, draw=red!50!black, fill=red!5,
        rounded corners=2pt, minimum width=3.0cm, minimum height=0.7cm,
        align=center, line width=0.4pt, font=\small
    },
    output/.style = {
        rectangle, draw=green!50!black, fill=green!6,
        rounded corners=2pt, minimum width=2.2cm, minimum height=0.6cm,
        align=center, line width=0.4pt
    },
    arr/.style = {-{Latex[length=2mm]}, thick, draw=black!50},
]

% Inputs
\node[box] (imp) {$\text{imp}(i)$\\graph importance};
\node[box, below=of imp] (unc) {$u(i) = 1$\\uncertainty};
\node[box, below=of unc] (lambda) {$\lambda_\ell$\\layer prior};

% Pragmatic term
\node[formula, right=1.6cm of imp] (pragmatic)
    {Pragmatic:\\$\text{imp}(i) \times \lambda_\ell$};

% Epistemic term
\node[formula, right=1.6cm of unc] (epistemic)
    {Epistemic:\\$w_{\text{explore}} \times u(i)$};

% Combine
\node[formula, right=1.6cm of epistemic, yshift=0.6cm] (combine)
    {$S(i) = $ pragmatic\\$+$ epistemic};

% Selection
\node[output, right=1.2cm of combine] (select)
    {$i^* = \arg\max_i S(i)$};

% Update box
\node[output, below=0.8cm of select] (update_box)
    {After ablation:\\$u(i^*) \gets 0$\\$\lambda_\ell \gets \lambda_\ell + |\Delta\text{KL}|$};

% Arrows
\draw[arr] (imp) -- (pragmatic);
\draw[arr] (lambda.east) -- ++(0.4,0) |- (pragmatic.south west);
\draw[arr] (unc) -- (epistemic);
\draw[arr] (pragmatic) -| (combine);
\draw[arr] (epistemic) -- (combine);
\draw[arr] (combine) -- (select);
\draw[arr] (select) -- (update_box);
\draw[arr, dashed, draw=black!30] (update_box.west) -- ++(-3.0,0) |- (unc.east)
    node[pos=0.1, below, font=\scriptsize]{next iteration};

\end{tikzpicture}
