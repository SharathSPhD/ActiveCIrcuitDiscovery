% figures/efe_pipeline.tex -- Scoring function pipeline (TikZ)
% Compact version for IEEE single-column

\begin{tikzpicture}[
    font=\scriptsize,
    node distance = 0.45cm and 0.7cm,
    box/.style = {
        rectangle, draw=black!60, fill=blue!6,
        rounded corners=2pt, minimum width=1.6cm, minimum height=0.5cm,
        align=center, line width=0.4pt
    },
    formula/.style = {
        rectangle, draw=red!50!black, fill=red!5,
        rounded corners=2pt, minimum width=2.0cm, minimum height=0.55cm,
        align=center, line width=0.4pt
    },
    output/.style = {
        rectangle, draw=green!50!black, fill=green!6,
        rounded corners=2pt, minimum width=1.8cm, minimum height=0.5cm,
        align=center, line width=0.4pt
    },
    arr/.style = {-{Latex[length=1.5mm]}, semithick, draw=black!50},
]

% Inputs (stacked vertically)
\node[box] (imp) {$\text{imp}(i)$};
\node[box, below=of imp] (unc) {$u(i)$};
\node[box, below=of unc] (lambda) {$\lambda_\ell$};

% Pragmatic term
\node[formula, right=0.9cm of imp] (pragmatic)
    {Pragmatic:\\$\text{imp}(i) \cdot \lambda_\ell$};

% Epistemic term
\node[formula, right=0.9cm of unc] (epistemic)
    {Epistemic:\\$\omega_e \cdot u(i)$};

% Combine
\node[formula, right=0.7cm of epistemic, yshift=0.45cm] (combine)
    {$S(i) = \text{prag.} + \text{epist.}$};

% Selection
\node[output, right=0.6cm of combine] (select)
    {$i^* = \arg\max S$};

% Update box
\node[output, below=0.5cm of select] (update_box)
    {$u(i^*) \gets 0$\\update $\lambda_\ell$};

% Arrows
\draw[arr] (imp) -- (pragmatic);
\draw[arr] (lambda.east) -- ++(0.25,0) |- (pragmatic.south west);
\draw[arr] (unc) -- (epistemic);
\draw[arr] (pragmatic) -| (combine);
\draw[arr] (epistemic) -- (combine);
\draw[arr] (combine) -- (select);
\draw[arr] (select) -- (update_box);
\draw[arr, dashed, draw=black!30] (update_box.west) -- ++(-2.2,0) |- (unc.east)
    node[pos=0.1, below, font=\tiny]{next step};

\end{tikzpicture}
