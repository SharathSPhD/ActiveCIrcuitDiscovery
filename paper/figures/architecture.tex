% figures/architecture.tex -- System architecture diagram (TikZ)
% Updated to reflect current ActiveInferenceSelector architecture

\begin{tikzpicture}[
    font=\small,
    node distance = 0.9cm and 1.5cm,
    box/.style = {
        rectangle, draw=black!70, fill=blue!8,
        rounded corners=3pt, minimum width=2.6cm, minimum height=0.7cm,
        align=center, line width=0.5pt
    },
    redbox/.style = {
        rectangle, draw=red!60!black, fill=red!8,
        rounded corners=3pt, minimum width=2.6cm, minimum height=0.7cm,
        align=center, line width=0.5pt
    },
    greenbox/.style = {
        rectangle, draw=green!50!black, fill=green!8,
        rounded corners=3pt, minimum width=2.6cm, minimum height=0.7cm,
        align=center, line width=0.5pt
    },
    greybox/.style = {
        rectangle, draw=black!40, fill=black!4,
        rounded corners=3pt, minimum width=2.6cm, minimum height=0.7cm,
        align=center, line width=0.5pt
    },
    arr/.style = {-{Latex[length=2mm]}, thick, draw=black!60},
    darr/.style = {{Latex[length=2mm]}-{Latex[length=2mm]}, thick, draw=black!40, dashed},
    groupbox/.style = {
        draw=black!30, dashed, fill=none, rounded corners=6pt, inner sep=6pt
    }
]

% ---- Input ----
\node[box] (prompt) {Prompt $x$};

% ---- Attribution column ----
\node[greybox, below=0.7cm of prompt] (model) {Gemma-2-2B\\+ Transcoders};
\node[greybox, below=0.6cm of model] (eap) {Edge Attribution\\Patching (EAP)};
\node[greybox, below=0.6cm of eap] (prune) {Prune graph\\(node/edge masks)};
\node[greybox, below=0.6cm of prune] (candidates) {Candidate features\\$\{(l_i, p_i, f_i)\}$};

% ---- AI Selector column (right) ----
\node[redbox, right=2.4cm of model] (importance) {Graph importance\\$\text{imp}(i)$};
\node[redbox, below=0.6cm of importance] (scoring) {Score = pragmatic\\+ epistemic};
\node[redbox, below=0.6cm of scoring] (select) {Select $i^*$\\$= \arg\max$ score};
\node[redbox, below=0.6cm of select] (intervene) {Ablate via\\\texttt{feature\_intervention}};
\node[redbox, below=0.6cm of intervene] (update) {Update $u(i)$,\\layer prior $\lambda_\ell$};

% ---- Output column ----
\node[greenbox, below=0.7cm of candidates, xshift=3.0cm] (kl) {KL divergence\\measurements};
\node[greenbox, below=0.5cm of kl] (ranking) {Feature causal\\ranking};

% ---- Labels ----
\node[above=0.1cm of importance, font=\footnotesize\itshape, text=red!70!black]
    {Active Inference Selector};

% ---- Grouping boxes ----
\begin{scope}[on background layer]
  \node[groupbox, fit=(model)(eap)(prune)(candidates),
        label={[font=\scriptsize, text=black!50]above:\texttt{circuit-tracer} pipeline}] {};
  \node[groupbox, draw=red!40, fit=(importance)(scoring)(select)(intervene)(update),
        label={[font=\scriptsize, text=red!60!black]above:Uncertainty-weighted loop}] {};
  \node[groupbox, draw=green!40, fit=(kl)(ranking),
        label={[font=\scriptsize, text=green!60!black]above:Outputs}] {};
\end{scope}

% ---- Arrows ----
\draw[arr] (prompt) -- (model);
\draw[arr] (model) -- (eap);
\draw[arr] (eap) -- (prune);
\draw[arr] (prune) -- (candidates);

% candidates -> importance (initialise)
\draw[arr] (candidates.east) -- ++(0.4,0) |- (importance.west)
    node[midway, above, font=\scriptsize]{init};

% Selector loop
\draw[arr] (importance) -- (scoring);
\draw[arr] (scoring) -- (select);
\draw[arr] (select) -- (intervene);
\draw[arr] (intervene.west) -- ++(-0.5,0) |- (model.east)
    node[pos=0.3, right, font=\scriptsize]{$(l,p,f,0)$};
\draw[arr] (intervene) -- (update);
\draw[arr] (update.north) -- ++(0, 0.15) -| (scoring.south east)
    node[pos=0.1, right, font=\scriptsize]{$\lambda_\ell, u(i)$};

% Convergence check
\draw[darr] (update.east) -- ++(0.5,0)
    node[right, font=\scriptsize]{budget?};

% Output arrows
\draw[arr] (update.south) -- ++(0,-0.3) -| (kl.north);
\draw[arr] (kl) -- (ranking);

\end{tikzpicture}
